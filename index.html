<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ventas Medio Mayor - Jardín Semillitas</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e293b" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    .header-logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo-img {
      width: 140px;
      height: auto;
      border-radius: 12px;
    }

    h1 {
      text-align: center;
      margin: 6px 0 4px;
      font-size: 1.3rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-bottom: 10px;
    }

    .realtime-card {
      background: #111827;
      border-radius: 999px;
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      margin-bottom: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
    }

    .ticket-info,
    .stats-card {
      background: #020617;
      border-radius: 999px;
      padding: 6px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      margin-bottom: 8px;
      border: 1px solid #1f2937;
    }

    #ticket-actual {
      font-weight: 700;
      color: #38bdf8;
      letter-spacing: 0.08em;
    }

    #stats-total-ventas {
      font-weight: 600;
      color: #4ade80;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .product-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }

    .product-image {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .summary-card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .summary-list div {
      margin: 4px 0;
      padding: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e293b;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .btn {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      margin: 4px 0;
    }

    .btn-pay {
      background: #facc15;
      color: #1e3a8a;
      border: 2px solid #1d4ed8;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <div class="header-logo">
      <img src="img/semillitas.jpg" class="logo-img" alt="Jardín Semillitas">
    </div>

    <h1>Ventas Medio Mayor - Jardín Semillitas</h1>
    <p class="subtitle">Toca un producto para agregarlo a la venta actual.</p>

    <!-- Total vendido en tiempo real -->
    <div class="realtime-card">
      <span>Venta acumulada hoy:</span>
      <span id="realtime-amount">$0</span>
    </div>

    <!-- Ticket actual -->
    <div class="ticket-info">
      <span>Ticket actual:</span>
      <span id="ticket-actual">A00001</span>
    </div>

    <!-- Resumen del día: cantidad de ventas + total -->
    <div class="stats-card">
      <span id="stats-cantidad-ventas">0 ventas</span>
      <span id="stats-total-ventas">$0</span>
    </div>

    <div class="products-grid">
      <button class="product-card" data-producto="Empanada de queso" data-precio="1000">
        <img src="img/empanada.jpg" class="product-image" alt="Empanada de queso">
        Empanada de queso — $1.000
      </button>

      <button class="product-card" data-producto="Papas fritas" data-precio="2000">
        <img src="img/papas.jpg" class="product-image" alt="Papas fritas">
        Papas fritas — $2.000
      </button>
    </div>

    <!-- Venta actual -->
    <div class="summary-card">
      <h3>Venta actual</h3>
      <div id="summary-list"></div>

      <h3>Total: <span id="total-amount">$0</span></h3>

      <button id="btn-nueva" class="btn" style="background:#334155; color:white;">Nueva venta</button>
      <button id="btn-cobrar" class="btn btn-pay">Cobrar / Imprimir</button>
    </div>

    <!-- Cierre del día -->
    <div class="summary-card">
      <h3>Cierre del día: <span id="cierre-fecha"></span></h3>
      <p id="cierre-cantidad"></p>
      <p id="cierre-total"></p>

      <button id="btn-ver-cierre" class="btn" style="background:#334155; color:white;">Ver cierre</button>
      <button id="btn-imprimir-cierre" class="btn" style="background:#22c55e;">Imprimir cierre</button>
      <button id="btn-reset-cierre" class="btn btn-danger">Reset día</button>
    </div>

  </div>

<script>
/* ---------------------------------
   SERVICE WORKER
---------------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

/* ---------------------------------
   CONSTANTES STORAGE
---------------------------------- */
const STORAGE_KEY_STATS = "semillitasStatsDia";         // { fecha: { totalVentas, cantidadVentas } }
const STORAGE_KEY_CORR  = "semillitasCorrelativoDia";   // { fecha: ultimoNumero }

/* ---------------------------------
   ESTADO GLOBAL DE LA VENTA ACTUAL
---------------------------------- */
let lineasVenta = [];  // Cada item = { nombre, precio }

/* ---------------------------------
   UTILIDADES
---------------------------------- */
function formatearCLP(v) {
  return v.toLocaleString("es-CL", {
    style: "currency",
    currency: "CLP",
    maximumFractionDigits: 0
  });
}

function getFechaClave() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/* Letra del ticket según día del mes (1=A, 2=B, ..., 27= A de nuevo) */
function getLetraDia(fecha) {
  const dia = fecha.getDate(); // 1–31
  const index = (dia - 1) % 26; // 0–25
  return String.fromCharCode("A".charCodeAt(0) + index);
}

function getCodigoTicket(numero) {
  const hoy = new Date();
  const letra = getLetraDia(hoy);
  return letra + String(numero).padStart(5, "0");
}

/* ---------------------------------
   CORRELATIVO POR DÍA
---------------------------------- */
function obtenerCorrelativoHoy() {
  const fechaClave = getFechaClave();
  let data = {};
  try {
    data = JSON.parse(localStorage.getItem(STORAGE_KEY_CORR) || "{}");
  } catch (e) {
    data = {};
  }
  const ultimo = data[fechaClave] || 0;
  return { fechaClave, data, ultimo };
}

function actualizarTicketActualUI() {
  const { ultimo } = obtenerCorrelativoHoy();
  const siguiente = ultimo + 1;
  const codigo = getCodigoTicket(siguiente);
  const el = document.getElementById("ticket-actual");
  if (el) el.textContent = codigo;
}

/* ---------------------------------
   STATS DEL DÍA (TOTAL + CANTIDAD)
---------------------------------- */
function obtenerStatsHoy() {
  const fechaClave = getFechaClave();
  let data = {};
  try {
    data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || "{}");
  } catch (e) {
    data = {};
  }
  const stats = data[fechaClave] || { totalVentas: 0, cantidadVentas: 0 };
  return { fechaClave, data, stats };
}

function guardarStatsHoy(fechaClave, data, stats) {
  data[fechaClave] = stats;
  localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data));
}

function cargarStatsDia() {
  const { fechaClave, stats } = obtenerStatsHoy();
  const totalFmt = formatearCLP(stats.totalVentas);

  // Venta acumulada hoy (barra superior)
  const realtime = document.getElementById("realtime-amount");
  if (realtime) realtime.textContent = totalFmt;

  // Tarjeta de stats
  const statsCant = document.getElementById("stats-cantidad-ventas");
  const statsTot = document.getElementById("stats-total-ventas");
  if (statsCant) statsCant.textContent = `${stats.cantidadVentas} venta${stats.cantidadVentas !== 1 ? "s" : ""}`;
  if (statsTot) statsTot.textContent = totalFmt;

  // Cierre del día
  const cierreFecha = document.getElementById("cierre-fecha");
  const cierreCantidad = document.getElementById("cierre-cantidad");
  const cierreTotal = document.getElementById("cierre-total");

  if (cierreFecha) cierreFecha.textContent = fechaClave;
  if (cierreCantidad) cierreCantidad.textContent = `Cantidad de ventas: ${stats.cantidadVentas}`;
  if (cierreTotal) cierreTotal.textContent = `Total vendido: ${totalFmt}`;
}

/* ---------------------------------
   VENTA ACTUAL (LÍNEA POR LÍNEA)
---------------------------------- */
function agregarLinea(nombre, precio) {
  lineasVenta.push({ nombre, precio });
  renderVentaActual();
}

function renderVentaActual() {
  const list = document.getElementById("summary-list");
  const totalEl = document.getElementById("total-amount");

  if (!list || !totalEl) return;

  list.innerHTML = "";

  if (lineasVenta.length === 0) {
    list.innerHTML = "<p style='opacity:0.6;'>Aún no agregas productos.</p>";
    totalEl.textContent = "$0";
    return;
  }

  let total = 0;

  lineasVenta.forEach((l, index) => {
    total += l.precio;

    const row = document.createElement("div");
    row.innerHTML = `
      <span>- ${l.nombre} (1)</span>
      <button data-index="${index}" 
        style="background:#dc2626;color:#fff;border:none;border-radius:6px;
               padding:2px 6px; cursor:pointer;">X</button>
    `;

    row.querySelector("button").addEventListener("click", () => {
      lineasVenta.splice(index, 1);
      renderVentaActual();
    });

    list.appendChild(row);
  });

  totalEl.textContent = formatearCLP(total);
}

/* ---------------------------------
   IMPRESIÓN (VENTANA + ESTILO POS)
---------------------------------- */
function imprimirTicket(texto) {
  const w = window.open("", "_blank", "width=350,height=600");
  if (!w) {
    alert("El navegador bloqueó la ventana de impresión.");
    return;
  }

  const safeTexto = texto
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8" />
      <style>
        body {
          margin: 0;
          padding: 10px;
          font-family: "Courier New", monospace;
          font-size: 14px;
        }
        .ticket {
          width: 240px; /* aprox 58mm */
          white-space: pre-wrap;
          line-height: 1.3;
        }
        @page { margin: 5mm; }
      </style>
    </head>
    <body>
      <div class="ticket">${safeTexto}</div>
    </body>
    </html>
  `;

  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(() => w.print(), 300);
}

/* ---------------------------------
   TICKET DE VENTA
---------------------------------- */
function generarTicketVenta(codigoTicket, totalTicket) {
  let t = "";

  t += "   COMPROBANTE DE VENTA\n";
  t += "     JARDÍN SEMILLITAS\n";
  t += "------------------------------\n";

  const fecha = new Date();
  t += "Fecha: " + fecha.toLocaleString("es-CL") + "\n";
  t += "Ticket: " + codigoTicket + "\n";
  t += "------------------------------\n";

  t += "PRODUCTOS:\n";

  lineasVenta.forEach(l => {
    t += `- ${l.nombre}\n   ${formatearCLP(l.precio)}\n`;
  });

  t += "------------------------------\n";
  t += `TOTAL: ${formatearCLP(totalTicket)}\n`;
  t += "------------------------------\n";
  t += " Gracias por su compra\n\n";

  return t;
}

/* ---------------------------------
   TICKET DE CIERRE DEL DÍA
---------------------------------- */
function generarTicketCierre() {
  const { fechaClave, stats } = obtenerStatsHoy();
  let t = "";

  t += "        CIERRE DEL DÍA\n";
  t += "      JARDÍN SEMILLITAS\n";
  t += "------------------------------\n";
  t += "Fecha: " + fechaClave + "\n";
  t += "------------------------------\n";
  t += `Cantidad de ventas: ${stats.cantidadVentas}\n`;
  t += `Total vendido:      ${formatearCLP(stats.totalVentas)}\n`;
  t += "------------------------------\n";
  t += " Fin del cierre\n\n";

  return t;
}

/* ---------------------------------
   EVENTOS
---------------------------------- */
document.querySelectorAll(".product-card").forEach(btn => {
  btn.addEventListener("click", () => {
    const nombre = btn.dataset.producto;
    const precio = Number(btn.dataset.precio);
    agregarLinea(nombre, precio);
  });
});

document.getElementById("btn-nueva").addEventListener("click", () => {
  lineasVenta = [];
  renderVentaActual();
});

/* Cobrar / Imprimir ticket */
document.getElementById("btn-cobrar").addEventListener("click", () => {
  if (lineasVenta.length === 0) {
    alert("No hay productos agregados.");
    return;
  }

  // Total del ticket actual
  const totalTicket = lineasVenta.reduce((sum, l) => sum + l.precio, 0);

  // Correlativo de hoy
  const { fechaClave, data: dataCorr, ultimo } = obtenerCorrelativoHoy();
  const numeroNuevo = ultimo + 1;
  const codigoTicket = getCodigoTicket(numeroNuevo);

  // Actualizar correlativo en storage
  dataCorr[fechaClave] = numeroNuevo;
  localStorage.setItem(STORAGE_KEY_CORR, JSON.stringify(dataCorr));
  actualizarTicketActualUI();

  // Actualizar stats del día
  const statsData = obtenerStatsHoy();
  const stats = statsData.stats;
  stats.cantidadVentas += 1;
  stats.totalVentas += totalTicket;
  guardarStatsHoy(statsData.fechaClave, statsData.data, stats);
  cargarStatsDia();

  // Imprimir ticket
  const textoTicket = generarTicketVenta(codigoTicket, totalTicket);
  imprimirTicket(textoTicket);

  // Limpiar venta actual
  lineasVenta = [];
  renderVentaActual();
});

/* Ver cierre → refresca stats en pantalla */
document.getElementById("btn-ver-cierre").addEventListener("click", () => {
  cargarStatsDia();
  alert("Cierre del día actualizado en pantalla.");
});

/* Imprimir cierre */
document.getElementById("btn-imprimir-cierre").addEventListener("click", () => {
  const texto = generarTicketCierre();
  imprimirTicket(texto);
});

/* Reset día: deja en 0 cantidad y total */
document.getElementById("btn-reset-cierre").addEventListener("click", () => {
  if (!confirm("ATENCIÓN: Vas a resetear las ventas de hoy. ¿Seguro?")) return;

  const { fechaClave, data, stats } = obtenerStatsHoy();
  stats.totalVentas = 0;
  stats.cantidadVentas = 0;
  guardarStatsHoy(fechaClave, data, stats);
  cargarStatsDia();
  alert("Ventas del día reseteadas.");
});

/* ---------------------------------
   ESTADO INICIAL
---------------------------------- */
renderVentaActual();
cargarStatsDia();
updated = false;
actualizarTicketActualUI();
</script>

</body>
</html>
