<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Ventas Medio Mayor - Jardín Semillitas</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e293b" />

  <!-- ESTILOS -->
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #f1f5f9;
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
    }
    .app-container {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }
    .header-logo {
      text-align: center;
      margin-bottom: 8px;
    }
    .logo-img {
      width: 130px;
      border-radius: 10px;
    }
    h1 {
      margin: 4px 0;
      text-align: center;
      font-size: 1.35rem;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }

    .realtime-card {
      background: #111827;
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      border: 1px solid #1f2937;
      box-shadow: 0 3px 8px rgba(0,0,0,0.5);
    }
    .realtime-amount {
      font-weight: bold;
      color: #4ade80;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 12px;
      margin-bottom: 14px;
    }
    .product-card {
      background: #1e293b;
      padding: 8px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .product-card:active {
      border-color: #38bdf8;
      transform: scale(.97);
    }
    .product-image {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 6px;
    }

    .summary-card {
      background: #020617;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .line-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2px 0;
    }
    .remove-btn {
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 0.7rem;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btn {
      flex: 1;
      border: none;
      padding: 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-pay {
      background: #facc15;
      color: #1e3a8a;
      border: 2px solid #1e40af;
    }
    .btn-secondary { background: #334155; color:#fff; }
    .btn-primary { background:#22c55e; color:#064e3b; }
    .btn-danger { background:#dc2626; color:#fff; border:2px solid #7f1d1d;}
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>
<body>

  <div class="app-container">

    <div class="header-logo">
      <img src="img/semillitas.jpg" class="logo-img" alt="Jardín Semillitas" />
    </div>

    <h1>Ventas Nivel Medio Mayor<br>Jardín Semillitas</h1>
    <p class="subtitle">Toca un producto para agregarlo a la venta.</p>

    <div class="realtime-card">
      <span>Venta acumulada hoy:</span>
      <span id="realtime-amount" class="realtime-amount">$0</span>
    </div>

    <div class="products-grid">
      <button class="product-card" data-producto="Emp. de queso" data-precio="1000">
        <img src="img/empanada.jpg" class="product-image" alt="Emp. de queso" />
        <div>Emp. de queso</div>
        <div>$1.000 c/u</div>
      </button>

      <button class="product-card" data-producto="Papas fritas" data-precio="2000">
        <img src="img/papas.jpg" class="product-image" alt="Papas fritas" />
        <div>Papas fritas</div>
        <div>$2.000 porción</div>
      </button>
    </div>

    <!-- Venta actual -->
    <div class="summary-card">
      <div class="summary-header">
        <span>Venta actual</span>
        <span id="items-count">0 ítems</span>
      </div>

      <div id="summary-list"></div>

      <div class="summary-total" style="display:flex;justify-content:space-between;margin-top:8px;border-top:1px solid #1f2937;padding-top:6px;">
        <span>Total</span>
        <span id="total-amount">$0</span>
      </div>

      <div class="btn-row">
        <button id="btn-nueva" class="btn btn-secondary">Nueva</button>
        <button id="btn-cobrar" class="btn btn-pay">Cobrar / Imprimir</button>
      </div>
    </div>

    <!-- Cierre del día -->
    <div class="summary-card">
      <div class="summary-header">
        <span>Cierre del día</span>
        <span id="cierre-fecha"></span>
      </div>

      <p id="cierre-empanadas">Emp. de queso: 0</p>
      <p id="cierre-papas">Papas fritas: 0</p>
      <p id="cierre-total">Total vendido: $0</p>

      <div class="btn-row">
        <button id="btn-ver-cierre" class="btn btn-secondary">Ver</button>
        <button id="btn-imprimir-cierre" class="btn btn-primary">Imprimir</button>
        <button id="btn-exportar-excel" class="btn btn-secondary">Exportar Excel</button>
        <button id="btn-reset-cierre" class="btn btn-danger">Reset</button>
      </div>
    </div>

  </div>

<script>
/* -----------------------------------------------------------------------
   FUNCIONES BASE
------------------------------------------------------------------------ */

// Separador CLP con ".", sin depender del navegador
function formatearCLP(valor) {
  return "$" + valor.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function getFechaHoraPartes() {
  const f = new Date();
  const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const d = String(f.getDate()).padStart(2,"0");
  const m = meses[f.getMonth()];
  const a = f.getFullYear();
  const h = String(f.getHours()).padStart(2,"0");
  const mm = String(f.getMinutes()).padStart(2,"0");

  return {
    fechaStr: `${d}-${m}-${a}`,
    horaStr:  `${h}:${mm}`
  };
}

function fechaClaveHoy() {
  return new Date().toISOString().slice(0,10);
}

/* -----------------------------------------------------------------------
   VARIABLES Y STORAGE
------------------------------------------------------------------------ */
const productos = [];
const STORAGE_KEY_TOTALES  = "totalesDiaEmpanadasPapas";
const STORAGE_KEY_TICKETS  = "ticketsDiaEmpanadasPapas";
const STORAGE_KEY_CORR     = "semillitasCorrelativoDia";

let logoDataUrl = null;

/* -----------------------------------------------------------------------
   ACTUALIZACIÓN DE PANTALLA (VENTA)
------------------------------------------------------------------------ */
function actualizarResumen() {
  const cont = document.getElementById("summary-list");
  cont.innerHTML = "";
  let total = 0;

  productos.forEach((p,i)=>{
    total += p.precio;
    const row = document.createElement("div");
    row.className = "line-item";
    row.innerHTML = `
      <span>- ${p.nombre} ${formatearCLP(p.precio)}</span>
      <button class="remove-btn" data-index="${i}">X</button>
    `;
    cont.appendChild(row);
  });

  document.getElementById("items-count").textContent = `${productos.length} ítems`;
  document.getElementById("total-amount").textContent = formatearCLP(total);
}

document.addEventListener("click", e=>{
  if(e.target.classList.contains("remove-btn")) {
    const i = Number(e.target.dataset.index);
    productos.splice(i,1);
    actualizarResumen();
  }
});

document.querySelectorAll(".product-card").forEach(btn=>{
  btn.onclick = ()=>{
    productos.push({
      nombre: btn.dataset.producto,
      precio: Number(btn.dataset.precio)
    });
    actualizarResumen();
  };
});

/* -----------------------------------------------------------------------
   CARGAR Y GUARDAR TOTALES DEL DÍA
------------------------------------------------------------------------ */
function cargarTotalesDia() {
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  document.getElementById("cierre-fecha").textContent = hoy;
  document.getElementById("cierre-empanadas").textContent = `Emp. de queso: ${t.empanadas}`;
  document.getElementById("cierre-papas").textContent = `Papas fritas: ${t.papas}`;
  document.getElementById("cierre-total").textContent = `Total vendido: ${formatearCLP(t.total)}`;
  document.getElementById("realtime-amount").textContent = formatearCLP(t.total);
}
cargarTotalesDia();

function actualizarTotalesDiaDesdeVenta() {
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  let totalVenta = 0;
  productos.forEach(p=>{
    totalVenta += p.precio;
    if (p.nombre === "Emp. de queso") t.empanadas += 1;
    if (p.nombre === "Papas fritas") t.papas += 1;
  });

  t.total += totalVenta;

  data[hoy] = t;
  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(data));
  cargarTotalesDia();
}

/* -----------------------------------------------------------------------
   CORRELATIVO POR DÍA
------------------------------------------------------------------------ */
function obtenerCorrelativoHoy() {
  const hoy = fechaClaveHoy();
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_CORR) || "{}");
  const actual = data[hoy] || 0;
  return { hoy, data, actual };
}

function generarNumeroTicket() {
  const { hoy, data, actual } = obtenerCorrelativoHoy();
  const nuevo = actual + 1;

  const mes = new Date().getMonth(); // A..L
  const letra = String.fromCharCode(65 + mes);

  data[hoy] = nuevo;
  localStorage.setItem(STORAGE_KEY_CORR, JSON.stringify(data));

  return `${letra}${String(nuevo).padStart(5,"0")}`;
}

/* -----------------------------------------------------------------------
   LOGO → BASE64 DESDE <img>
------------------------------------------------------------------------ */
async function obtenerLogoDataUrl() {
  if (logoDataUrl) return logoDataUrl;

  const img = document.querySelector(".logo-img");
  if (!img) return null;

  if (!img.complete) {
    await new Promise(resolve => {
      img.onload = resolve;
      img.onerror = resolve;
    });
  }

  try {
    const canvas = document.createElement("canvas");
    canvas.width  = img.naturalWidth;
    canvas.height = img.naturalHeight;
    canvas.getContext("2d").drawImage(img, 0, 0);
    logoDataUrl = canvas.toDataURL("image/jpeg");
    return logoDataUrl;
  } catch (e) {
    console.error("Error base64 logo:", e);
    return null;
  }
}

/* -----------------------------------------------------------------------
   GENERAR TEXTO DEL TICKET
------------------------------------------------------------------------ */
function generarTextoTicket(ticketId) {
  const total = productos.reduce((s,p)=>s+p.precio,0);
  const { fechaStr, horaStr } = getFechaHoraPartes();

  const conteo = {};
  productos.forEach(p=>{
    if (!conteo[p.nombre]) conteo[p.nombre] = 0;
    conteo[p.nombre] += 1;
  });

  let detalle = "";
  productos.forEach(p=> detalle += `- ${p.nombre}\n`);

  let resumen = "";
  for (const n in conteo) {
    const qty = conteo[n];
    const suf = (n === "Papas fritas") ? "pcn." : "un.";
    resumen += `${n} = ${qty} ${suf}\n`;
  }

  return `
COMPROBANTE DE VENTA
NIVEL MEDIO MAYOR
JARDÍN SEMILLITAS
------------------------------
Fecha: ${fechaStr}
Hora:  ${horaStr}
Ticket: ${ticketId}
------------------------------
DETALLE:
${detalle}
------------------------------
RESUMEN:
${resumen}
------------------------------
Total a pagar: ${formatearCLP(total)}
------------------------------
Gracias por su compra
`.trim();
}

/* -----------------------------------------------------------------------
   IMPRESIÓN CON jsPDF (POS-58)
------------------------------------------------------------------------ */
async function imprimirTicket(texto) {
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF({
    unit:"mm",
    format:[48, 200] // alto generoso
  });

  doc.setFont("helvetica","normal");
  doc.setFontSize(9);

  let y = 5;

  const logo = await obtenerLogoDataUrl();
  if (logo) {
    const w = 30, h = 20;
    const x = (48 - w) / 2;
    doc.addImage(logo, "JPEG", x, y, w, h);
    y += h + 4;
  }

  const lineas = texto.split(/\n/);
  const lh = 4;

  lineas.forEach(l=>{
    doc.text(l || " ", 2, y, { maxWidth: 44 });
    y += lh;
  });

  window.open(doc.output("bloburl"), "_blank");
}

/* -----------------------------------------------------------------------
   GUARDAR TICKET DEL DÍA
------------------------------------------------------------------------ */
function guardarTicketDelDia(ticketRecord) {
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TICKETS) || "{}");
  const hoy = fechaClaveHoy();

  if (!data[hoy]) data[hoy] = [];
  data[hoy].push(ticketRecord);

  localStorage.setItem(STORAGE_KEY_TICKETS, JSON.stringify(data));
}

/* -----------------------------------------------------------------------
   EXPORTAR EXCEL
------------------------------------------------------------------------ */
async function exportarExcelDelDia() {
  const hoy = fechaClaveHoy();
  const ticketsData = JSON.parse(localStorage.getItem(STORAGE_KEY_TICKETS) || "{}");
  const tickets = ticketsData[hoy] || [];

  if (tickets.length === 0) {
    alert("No hay ventas registradas para exportar.");
    return;
  }

  const filas = [
    ["Fecha","Hora","Producto","Cantidad","Precio Unit.","Subtotal","Ticket Nº"]
  ];

  tickets.forEach(tk=>{
    const f = new Date(tk.fechaHoraISO);
    const fechaStr = f.toLocaleDateString("es-CL");
    const horaStr = f.toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"});

    tk.items.forEach(item=>{
      filas.push([
        fechaStr,
        horaStr,
        item.nombre,
        item.cantidad,
        formatearCLP(item.precio),
        formatearCLP(item.subtotal),
        tk.ticketId
      ]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(filas);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ventas");

  const { fechaStr } = getFechaHoraPartes();
  const nombreFinal = `Ventas_MedioMayor_${fechaStr.replace(/-/g,"")}.xlsx`;

  XLSX.writeFile(wb, nombreFinal);
}

/* -----------------------------------------------------------------------
   BOTONES
------------------------------------------------------------------------ */
document.getElementById("btn-cobrar").onclick = async ()=>{
  if (productos.length === 0) {
    alert("No hay productos.");
    return;
  }

  const ticketId = generarNumeroTicket();
  const t = generarTextoTicket(ticketId);

  // guardar ticket completo
  const fecha = new Date();
  const ticketRecord = {
    fechaHoraISO: fecha.toISOString(),
    items: productos.map(p=>({
      nombre: p.nombre,
      cantidad: 1,
      precio: p.precio,
      subtotal: p.precio
    })),
    total: productos.reduce((s,p)=>s+p.precio,0),
    ticketId: ticketId
  };
  guardarTicketDelDia(ticketRecord);

  actualizarTotalesDiaDesdeVenta();
  await imprimirTicket(t);

  productos.length = 0;
  actualizarResumen();
};

document.getElementById("btn-nueva").onclick = ()=>{
  productos.length = 0;
  actualizarResumen();
};

document.getElementById("btn-ver-cierre").onclick = ()=>{
  cargarTotalesDia();
  alert("Cierre actualizado.");
};

document.getElementById("btn-imprimir-cierre").onclick = async ()=>{
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  const { fechaStr, horaStr } = getFechaHoraPartes();

  const texto = `
CIERRE DEL DÍA
NIVEL MEDIO MAYOR
JARDÍN SEMILLITAS
------------------------------
Fecha: ${fechaStr}
Hora:  ${horaStr}
------------------------------
Emp. de queso: ${t.empanadas} un.
Papas fritas:  ${t.papas} pcn.
------------------------------
Total vendido: ${formatearCLP(t.total)}
------------------------------
Fin del cierre
  `.trim();

  await imprimirTicket(texto);
};

document.getElementById("btn-exportar-excel").onclick = exportarExcelDelDia;

document.getElementById("btn-reset-cierre").onclick = ()=>{
  if (!confirm("¿Resetear el día?")) return;

  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  let dataTickets = JSON.parse(localStorage.getItem(STORAGE_KEY_TICKETS)||"{}");
  const hoy = fechaClaveHoy();

  delete data[hoy];
  delete dataTickets[hoy];

  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(data));
  localStorage.setItem(STORAGE_KEY_TICKETS, JSON.stringify(dataTickets));

  cargarTotalesDia();
  alert("Día reseteado.");
};
</script>

</body>
</html>
