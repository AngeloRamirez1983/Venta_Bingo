<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ventas Nivel Medio Mayor - Jardín Semillitas</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e293b" />

  <!-- jsPDF para impresión vía PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      padding: 16px;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header-logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo-img {
      width: 140px;
      height: auto;
      border-radius: 12px;
    }

    .app-title {
      text-align: center;
      font-size: 1.55rem;
      margin: 6px 0 0;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .app-subtitle {
      text-align: center;
      font-size: 1.15rem;
      margin: 2px 0 8px;
      font-weight: 600;
      color: #cdd6f6;
      letter-spacing: 0.3px;
    }

    .app-description {
      text-align: center;
      font-size: 0.88rem;
      color: #a8b0c7;
      margin-bottom: 12px;
      margin-top: -4px;
    }

    .realtime-card,
    .ticket-info,
    .stats-card {
      background: #111827;
      border-radius: 999px;
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border: 1px solid #1f2937;
      font-size: 0.9rem;
    }

    #ticket-actual {
      color: #38bdf8;
      font-weight: bold;
      letter-spacing: 0.08em;
    }

    #stats-total-ventas {
      color: #4ade80;
      font-weight: bold;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      margin-bottom: 16px;
    }

    .product-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 14px rgba(0,0,0,0.4);
    }

    .product-card:active {
      transform: scale(0.97);
      border-color: #38bdf8;
    }

    .product-image {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .summary-card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .summary-list div {
      margin: 4px 0;
      padding: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e293b;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      margin: 4px 0;
      font-size: 1rem;
    }

    .btn-pay {
      background: #facc15;
      color: #1e3a8a;
      border: 2px solid #1d4ed8;
    }

    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <div class="header-logo">
      <img src="img/semillitas.jpg" class="logo-img" alt="Jardín Semillitas">
    </div>

    <h1 class="app-title">Ventas Nivel Medio Mayor</h1>
    <h2 class="app-subtitle">Jardín Infantil Semillitas</h2>
    <p class="app-description">Selecciona un producto para agregarlo a la venta actual.</p>

    <div class="realtime-card">
      <span>Venta acumulada hoy:</span>
      <span id="realtime-amount">$0</span>
    </div>

    <div class="ticket-info">
      <span>Ticket actual:</span>
      <span id="ticket-actual">A00001</span>
    </div>

    <div class="stats-card">
      <span id="stats-cantidad-ventas">0 ventas</span>
      <span id="stats-total-ventas">$0</span>
    </div>

    <div class="products-grid">
      <button class="product-card" data-producto="Empanada de queso" data-precio="1000">
        <img src="img/empanada.jpg" class="product-image" alt="Empanada de queso">
        Empanada de queso — $1.000
      </button>

      <button class="product-card" data-producto="Papas fritas" data-precio="2000">
        <img src="img/papas.jpg" class="product-image" alt="Papas fritas">
        Papas fritas — $2.000
      </button>
    </div>

    <div class="summary-card">
      <h3>Venta actual</h3>
      <div id="summary-list"></div>
      <h3>Total: <span id="total-amount">$0</span></h3>

      <button id="btn-nueva" class="btn" style="background:#334155;color:white;">Nueva venta</button>
      <button id="btn-cobrar" class="btn btn-pay">Cobrar / Imprimir</button>
    </div>

    <div class="summary-card">
      <h3>Cierre del día: <span id="cierre-fecha"></span></h3>
      <p id="cierre-cantidad"></p>
      <p id="cierre-total"></p>

      <button id="btn-ver-cierre" class="btn" style="background:#334155;color:white;">Ver cierre</button>
      <button id="btn-imprimir-cierre" class="btn" style="background:#22c55e;">Imprimir cierre</button>
      <button id="btn-reset-cierre" class="btn btn-danger">Reset día</button>
    </div>
  </div>

<script>
/* ---------------------------
   SERVICE WORKER
---------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

/* ---------------------------
   STORAGE KEYS
---------------------------- */
const STORAGE_KEY_STATS = "semillitasStatsDia";
const STORAGE_KEY_CORR  = "semillitasCorrelativoDia";

let lineasVenta = [];

/* ---------------------------
   UTILIDADES
---------------------------- */
function formatearCLP(v) {
  return v.toLocaleString("es-CL", {
    style: "currency",
    currency: "CLP",
    maximumFractionDigits: 0
  });
}

function formatFechaHora() {
  const d = new Date();
  const dia = String(d.getDate()).padStart(2, "0");
  const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const mes = meses[d.getMonth()];
  const anio = d.getFullYear();

  const h  = String(d.getHours()).padStart(2, "0");
  const m  = String(d.getMinutes()).padStart(2, "0");

  return `${dia}-${mes}-${anio} ${h}:${m}`;
}

function getFechaClave() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function getLetraDia() {
  const dia = new Date().getDate();
  return String.fromCharCode("A".charCodeAt(0) + ((dia-1) % 26));
}

function getCodigoTicket(n) {
  return getLetraDia() + String(n).padStart(5,"0");
}

/* ---------------------------
   CORRELATIVO
---------------------------- */
function obtenerCorrelativoHoy() {
  const fechaClave = getFechaClave();
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_CORR) || "{}");
  return { fechaClave, data, ultimo: data[fechaClave] || 0 };
}

function actualizarTicketActualUI() {
  const { ultimo } = obtenerCorrelativoHoy();
  document.getElementById("ticket-actual").textContent =
    getCodigoTicket(ultimo + 1);
}

/* ---------------------------
   STATS
---------------------------- */
function obtenerStatsHoy() {
  const fechaClave = getFechaClave();
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_STATS) || "{}");
  const stats = data[fechaClave] || { cantidadVentas:0, totalVentas:0 };
  return { fechaClave, data, stats };
}

function guardarStatsHoy(f, data, stats) {
  data[f] = stats;
  localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(data));
}

function cargarStatsDia() {
  const { fechaClave, stats } = obtenerStatsHoy();

  document.getElementById("realtime-amount").textContent =
    formatearCLP(stats.totalVentas);

  document.getElementById("stats-cantidad-ventas").textContent =
    `${stats.cantidadVentas} venta${stats.cantidadVentas!==1?"s":""}`;

  document.getElementById("stats-total-ventas").textContent =
    formatearCLP(stats.totalVentas);

  document.getElementById("cierre-fecha").textContent = fechaClave;
  document.getElementById("cierre-cantidad").textContent =
    `Cantidad de ventas: ${stats.cantidadVentas}`;
  document.getElementById("cierre-total").textContent =
    `Total vendido: ${formatearCLP(stats.totalVentas)}`;
}

/* ---------------------------
   VENTA ACTUAL
---------------------------- */
function agregarLinea(nombre, precio) {
  lineasVenta.push({ nombre, precio });
  renderVentaActual();
}

function renderVentaActual() {
  const list = document.getElementById("summary-list");
  const totalEl = document.getElementById("total-amount");

  if (!lineasVenta.length) {
    list.innerHTML = "<p style='opacity:0.6;'>Aún no agregas productos.</p>";
    totalEl.textContent = "$0";
    return;
  }

  list.innerHTML = "";
  let total = 0;

  lineasVenta.forEach((l, index) => {
    total += l.precio;

    const row = document.createElement("div");
    row.innerHTML = `
      <span>- ${l.nombre} (1)</span>
      <button data-index="${index}"
        style="background:#dc2626;color:white;border:none;border-radius:6px;padding:2px 6px;cursor:pointer;">
        X
      </button>`;

    row.querySelector("button").addEventListener("click", () => {
      lineasVenta.splice(index, 1);
      renderVentaActual();
    });

    list.appendChild(row);
  });

  totalEl.textContent = formatearCLP(total);
}

/* ---------------------------
   IMPRESIÓN VIA PDF (jsPDF)
---------------------------- */
function imprimirTicket(texto) {
  // Verificamos que jsPDF esté disponible
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("Error: jsPDF no se ha cargado. Revisa la conexión a Internet.");
    console.error("jsPDF no encontrado en window.jspdf");
    return;
  }

  const { jsPDF } = window.jspdf;

  // Formato tipo térmica: 58mm de ancho, 200mm de alto (más que suficiente)
  const doc = new jsPDF({
    unit: "mm",
    format: [58, 200],  // [ancho, alto] en mm
  });

  // Texto en negro, font monoespaciada
  doc.setFont("courier", "bold");
  doc.setFontSize(8);

  const lineas = texto.split(/\r?\n/);
  let x = 2;    // margen izquierdo en mm
  let y = 6;    // margen superior en mm
  const lineHeight = 4; // espacio entre líneas

  lineas.forEach((linea) => {
    // Evitamos escribir fuera de la página
    if (y > 190) return;
    doc.text(linea || " ", x, y);
    y += lineHeight;
  });

  // OPCIÓN 1: abrir el PDF en otra pestaña para que lo veas
  const blobUrl = doc.output("bloburl");
  window.open(blobUrl, "_blank");

  // Si prefieres descargar directo, puedes usar esto en vez de lo anterior:
  // doc.save("ticket-semillitas.pdf");
}

  // Ajusta la altura real de la página a lo que usamos
  doc.internal.pageSize.height = y + 20;

  // AutoPrint + abrir en nueva pestaña para que el usuario mande a la térmica
  doc.autoPrint();
  const url = doc.output("bloburl");
  window.open(url, "_blank");
}

/* ---------------------------
   RESUMEN POR PRODUCTO
---------------------------- */
function agruparProductos() {
  const map = {};
  lineasVenta.forEach(l => {
    if (!map[l.nombre]) map[l.nombre] = { qty:0, total:0 };
    map[l.nombre].qty++;
    map[l.nombre].total += l.precio;
  });
  return map;
}

/* ---------------------------
   TICKET VENTA (TEXTO)
---------------------------- */
function generarTicketVenta(codigo, total) {
  let t = "";

  t += "      COMPROBANTE DE VENTA\n";
  t += "       NIVEL MEDIO MAYOR\n";
  t += "          SEMILLITAS\n";
  t += "--------------------------------\n";
  t += "Fecha: " + formatFechaHora() + "\n";
  t += "Ticket: " + codigo + "\n";
  t += "--------------------------------\n";

  t += "DETALLE:\n";
  lineasVenta.forEach(l => {
    t += `- ${l.nombre}\n`;
    t += `  ${formatearCLP(l.precio)}\n`;
  });

  const resumen = agruparProductos();

  t += "--------------------------------\n";
  t += "RESUMEN:\n";
  for (const prod in resumen) {
    const r = resumen[prod];
    t += `- ${prod} x ${r.qty} = ${formatearCLP(r.total)}\n`;
  }

  t += "--------------------------------\n";
  t += `TOTAL: ${formatearCLP(total)}\n`;
  t += "--------------------------------\n";
  t += "Gracias por su compra\n\n";

  return t;
}

/* ---------------------------
   TICKET CIERRE (TEXTO)
---------------------------- */
function generarTicketCierre() {
  const { fechaClave, stats } = obtenerStatsHoy();

  let t = "";
  t += "           CIERRE DEL DÍA\n";
  t += "        NIVEL MEDIO MAYOR\n";
  t += "           SEMILLITAS\n";
  t += "--------------------------------\n";
  t += "Fecha: " + fechaClave + "\n";
  t += "--------------------------------\n";
  t += `Ventas: ${stats.cantidadVentas}\n`;
  t += `Total:  ${formatearCLP(stats.totalVentas)}\n`;
  t += "--------------------------------\n";
  t += "Fin del cierre\n\n";

  return t;
}

/* ---------------------------
   EVENTOS
---------------------------- */
document.querySelectorAll(".product-card").forEach(btn=>{
  btn.addEventListener("click",()=>{
    agregarLinea(btn.dataset.producto, Number(btn.dataset.precio));
  });
});

document.getElementById("btn-nueva").addEventListener("click",()=>{
  lineasVenta = [];
  renderVentaActual();
});

document.getElementById("btn-cobrar").addEventListener("click",()=>{

  if (!lineasVenta.length) {
    alert("No hay productos agregados.");
    return;
  }

  const totalTicket = lineasVenta.reduce((s,l)=>s+l.precio,0);

  const { fechaClave, data: corrData, ultimo } = obtenerCorrelativoHoy();
  const numeroNuevo = ultimo + 1;
  corrData[fechaClave] = numeroNuevo;
  localStorage.setItem(STORAGE_KEY_CORR, JSON.stringify(corrData));
  const codigoTicket = getCodigoTicket(numeroNuevo);

  const statsData = obtenerStatsHoy();
  statsData.stats.cantidadVentas++;
  statsData.stats.totalVentas += totalTicket;
  guardarStatsHoy(statsData.fechaClave, statsData.data, statsData.stats);

  cargarStatsDia();

  const ticketTexto = generarTicketVenta(codigoTicket, totalTicket);
  imprimirTicket(ticketTexto);

  lineasVenta = [];
  renderVentaActual();
  actualizarTicketActualUI();
});

document.getElementById("btn-ver-cierre").addEventListener("click",()=>{
  cargarStatsDia();
  alert("Cierre del día actualizado.");
});

document.getElementById("btn-imprimir-cierre").addEventListener("click",()=>{
  const cierreTexto = generarTicketCierre();
  imprimirTicket(cierreTexto);
});

document.getElementById("btn-reset-cierre").addEventListener("click",()=>{
  if (!confirm("¿Seguro de eliminar todas las ventas de hoy?")) return;

  const { fechaClave, data, stats } = obtenerStatsHoy();
  stats.cantidadVentas = 0;
  stats.totalVentas = 0;
  guardarStatsHoy(fechaClave,data,stats);
  cargarStatsDia();
  alert("Ventas reseteadas.");
});

/* ---------------------------
   INIT
---------------------------- */
renderVentaActual();
cargarStatsDia();
actualizarTicketActualUI();

</script>

</body>
</html>
