<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Ventas Medio Mayor - Jardín Semillitas</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e293b" />

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #f1f5f9;
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
    }
    .app-container {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }
    .header-logo {
      text-align: center;
      margin-bottom: 8px;
    }
    .logo-img {
      width: 130px;
      border-radius: 10px;
    }
    h1 {
      margin: 4px 0;
      text-align: center;
      font-size: 1.35rem;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }

    .realtime-card {
      background: #111827;
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      border: 1px solid #1f2937;
      box-shadow: 0 3px 8px rgba(0,0,0,0.5);
    }
    .realtime-amount {
      font-weight: bold;
      color: #4ade80;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 12px;
      margin-bottom: 14px;
    }
    .product-card {
      background: #1e293b;
      padding: 8px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .product-card:active {
      border-color: #38bdf8;
      transform: scale(.97);
    }
    .product-image {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 6px;
    }

    .summary-card {
      background: #020617;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .summary-list p {
      margin: 4px 0;
    }
    .line-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2px 0;
    }
    .remove-btn {
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 0.7rem;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btn {
      flex: 1;
      border: none;
      padding: 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-pay {
      background: #facc15;
      color: #1e3a8a;
      border: 2px solid #1e40af;
    }
    .btn-secondary { background: #334155; color:#fff; }
    .btn-primary { background:#22c55e; color:#064e3b; }
    .btn-danger { background:#dc2626; color:#fff; border:2px solid #7f1d1d;}
  </style>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

  <div class="app-container">

    <div class="header-logo">
      <img src="img/semillitas.jpg" class="logo-img" />
    </div>

    <h1>Ventas Nivel Medio Mayor<br>Jardín Semillitas</h1>
    <p class="subtitle">Toca un producto para agregarlo a la venta.</p>

    <div class="realtime-card">
      <span>Venta acumulada hoy:</span>
      <span id="realtime-amount" class="realtime-amount">$0</span>
    </div>

    <div class="products-grid">
      <button class="product-card" data-producto="Empanada de queso" data-precio="1000">
        <img src="img/empanada.jpg" class="product-image" />
        <div>Empanada de queso</div>
        <div>$1.000 c/u</div>
      </button>

      <button class="product-card" data-producto="Papas fritas" data-precio="2000">
        <img src="img/papas.jpg" class="product-image" />
        <div>Papas fritas</div>
        <div>$2.000 porción</div>
      </button>
    </div>

    <!-- Venta actual -->
    <div class="summary-card">
      <div class="summary-header">
        <span>Venta actual</span>
        <span id="items-count">0 ítems</span>
      </div>

      <div id="summary-list"></div>

      <div class="summary-total" style="display:flex;justify-content:space-between;margin-top:8px;border-top:1px solid #1f2937;padding-top:6px;">
        <span>Total</span>
        <span id="total-amount">$0</span>
      </div>

      <div class="btn-row">
        <button id="btn-nueva" class="btn btn-secondary">Nueva</button>
        <button id="btn-cobrar" class="btn btn-pay">Cobrar / Imprimir</button>
      </div>
    </div>

    <!-- Cierre del día -->
    <div class="summary-card">
      <div class="summary-header">
        <span>Cierre del día</span>
        <span id="cierre-fecha"></span>
      </div>

      <p id="cierre-empanadas">Empanadas: 0</p>
      <p id="cierre-papas">Papas fritas: 0</p>
      <p id="cierre-total">Total vendido: $0</p>

      <div class="btn-row">
        <button id="btn-ver-cierre" class="btn btn-secondary">Ver</button>
        <button id="btn-imprimir-cierre" class="btn btn-primary">Imprimir</button>
        <button id="btn-reset-cierre" class="btn btn-danger">Reset</button>
      </div>
    </div>

  </div>

<script>
/* --------------------------------------------------------------
   SERVICE WORKER
---------------------------------------------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

/* --------------------------------------------------------------
   VARIABLES Y STORAGE
---------------------------------------------------------------- */
const productos = [];
const STORAGE_KEY_TOTALES  = "totalesDiaEmpanadasPapas";

/* --------------------------------------------------------------
   FORMATEOS
---------------------------------------------------------------- */
function formatearCLP(v) {
  return v.toLocaleString("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0});
}

function fechaVisible() {
  const f = new Date();
  const meses = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const d  = String(f.getDate()).padStart(2,"0");
  const m  = meses[f.getMonth()];
  const a  = f.getFullYear();
  const h  = String(f.getHours()).padStart(2,"0");
  const mm = String(f.getMinutes()).padStart(2,"0");
  return `${d}-${m}-${a} ${h}:${mm}`;
}

function fechaClaveHoy(){
  return new Date().toISOString().slice(0,10);
}

/* --------------------------------------------------------------
   VENTA ACTUAL
---------------------------------------------------------------- */
function actualizarResumen() {
  const cont = document.getElementById("summary-list");
  cont.innerHTML = "";
  let total = 0;

  productos.forEach((p,i)=>{
    total += p.precio;

    const row = document.createElement("div");
    row.className = "line-item";
    row.innerHTML = `
        <span>- ${p.nombre} $${p.precio.toLocaleString()}</span>
        <button class="remove-btn" data-index="${i}">X</button>
    `;
    cont.appendChild(row);
  });

  document.getElementById("items-count").textContent = `${productos.length} ítems`;
  document.getElementById("total-amount").textContent = formatearCLP(total);
}

document.addEventListener("click", e=>{
  if(e.target.classList.contains("remove-btn")) {
    const i = Number(e.target.dataset.index);
    productos.splice(i,1);
    actualizarResumen();
  }
});

document.querySelectorAll(".product-card").forEach(btn=>{
  btn.onclick = ()=>{
    productos.push({
      nombre: btn.dataset.producto,
      precio: Number(btn.dataset.precio)
    });
    actualizarResumen();
  };
});

/* --------------------------------------------------------------
   TOTALES DEL DÍA
---------------------------------------------------------------- */
function cargarTotalesDia() {
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  document.getElementById("cierre-fecha").textContent = hoy;
  document.getElementById("cierre-empanadas").textContent = `Empanadas: ${t.empanadas}`;
  document.getElementById("cierre-papas").textContent = `Papas fritas: ${t.papas}`;
  document.getElementById("cierre-total").textContent = `Total vendido: ${formatearCLP(t.total)}`;
  document.getElementById("realtime-amount").textContent = formatearCLP(t.total);
}

function actualizarTotalesDiaDesdeVenta() {
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  let totalVenta = 0;
  productos.forEach(p=>{
    totalVenta += p.precio;
    if (p.nombre === "Empanada de queso") t.empanadas += 1;
    if (p.nombre === "Papas fritas") t.papas += 1;
  });
  t.total += totalVenta;

  data[hoy] = t;
  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(data));
  cargarTotalesDia();
}

cargarTotalesDia();

/* --------------------------------------------------------------
   GENERAR TEXTO TICKET
---------------------------------------------------------------- */
function generarCorrelativo() {
  // Letra por mes + últimos 5 dígitos del timestamp
  const hoy = new Date();
  const letra = String.fromCharCode(65 + hoy.getMonth()); // A..L
  const num = Date.now().toString().slice(-5);
  return letra + num;
}

function generarTextoTicket() {
  let total = productos.reduce((s,p)=>s+p.precio,0);

  let detalle = "";
  let resumen = {};

  productos.forEach(p=>{
    detalle += `- ${p.nombre}\n  $${p.precio.toLocaleString()}\n`;
    if(!resumen[p.nombre]) resumen[p.nombre] = 0;
    resumen[p.nombre] += p.precio;
  });

  let resumenTxt = "";
  for(const k in resumen){
    resumenTxt += `- ${k} = ${formatearCLP(resumen[k])}\n`;
  }

  const ticket = `
COMPROBANTE DE VENTA
 NIVEL MEDIO MAYOR
 SEMILLITAS
--------------------------
Fecha: ${fechaVisible()}
Ticket: ${generarCorrelativo()}
--------------------------
DETALLE:
${detalle}
--------------------------
RESUMEN:
${resumenTxt}
--------------------------
TOTAL: ${formatearCLP(total)}
--------------------------
Gracias por su compra
  `.trim();

  return ticket;
}

/* --------------------------------------------------------------
   IMPRESIÓN POS-58 (48mm) CON LOGO
---------------------------------------------------------------- */
async function imprimirTicket(texto) {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("jsPDF no cargado");
    return;
  }
  const { jsPDF } = window.jspdf;

  async function cargarImagenBase64(url) {
    try {
      const resp = await fetch(url);
      const blob = await resp.blob();
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.error("Error cargando logo:", e);
      return null;
    }
  }

  const lineas = texto.split(/\r?\n/);
  let altura = Math.max(90, lineas.length * 4 + 70);

  const doc = new jsPDF({
    unit:"mm",
    format:[48, altura]
  });

  doc.setFont("courier","bold");
  doc.setFontSize(8);

  // Logo
  const imgBase64 = await cargarImagenBase64("img/semillitas.jpg");
  let cursorY = 4;

  if (imgBase64) {
    const logoAncho = 42;
    const logoAlto  = 42;
    const logoX = (48 - logoAncho) / 2;
    doc.addImage(imgBase64, "JPEG", logoX, cursorY, logoAncho, logoAlto);
    cursorY += logoAlto + 4;
  }

  const lh = 4;
  lineas.forEach(l=>{
    doc.text(l || " ", 2, cursorY);
    cursorY += lh;
  });

  doc.internal.pageSize.height = cursorY + 4;

  window.open(doc.output("bloburl"), "_blank");
}

/* --------------------------------------------------------------
   BOTONES
---------------------------------------------------------------- */
document.getElementById("btn-cobrar").onclick = async ()=>{
  if(productos.length===0){ alert("Sin productos"); return; }

  // Actualiza totales del día
  actualizarTotalesDiaDesdeVenta();

  const texto = generarTextoTicket();
  await imprimirTicket(texto);

  productos.length = 0;
  actualizarResumen();
};

document.getElementById("btn-nueva").onclick = ()=>{
  productos.length = 0;
  actualizarResumen();
};

document.getElementById("btn-ver-cierre").onclick = cargarTotalesDia;

document.getElementById("btn-imprimir-cierre").onclick = async ()=>{
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  const t = data[hoy] || {empanadas:0, papas:0, total:0};

  const texto = `
CIERRE DEL DÍA
 NIVEL MEDIO MAYOR
 SEMILLITAS
--------------------------
Fecha: ${hoy}
--------------------------
Empanadas: ${t.empanadas}
Papas fritas: ${t.papas}
Total: ${formatearCLP(t.total)}
--------------------------
Fin del cierre
  `.trim();

  await imprimirTicket(texto);
};

document.getElementById("btn-reset-cierre").onclick = ()=>{
  if(!confirm("¿Seguro que deseas resetear los totales de hoy?")) return;
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||"{}");
  const hoy = fechaClaveHoy();
  delete data[hoy];
  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(data));
  cargarTotalesDia();
  alert("Totales de hoy reseteados.");
};
</script>
</body>
</html>
