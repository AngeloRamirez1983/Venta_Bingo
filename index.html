<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ventas Medio Mayor - Jard칤n Semillitas</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Colores PWA -->
  <meta name="theme-color" content="#1e293b">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    .header-logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo-img {
      width: 140px;
      height: auto;
      border-radius: 12px;
    }

    h1 {
      text-align: center;
      margin: 6px 0 4px;
      font-size: 1.3rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-bottom: 10px;
    }

    .realtime-card {
      background: #111827;
      border-radius: 999px;
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      margin-bottom: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
    }

    .realtime-label {
      color: #9ca3af;
    }

    .realtime-amount {
      font-weight: 700;
      color: #4ade80;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .product-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.1s ease, border-color 0.1s ease, box-shadow 0.1s ease;
    }

    .product-card:active {
      transform: scale(0.97);
      box-shadow: 0 2px 6px rgba(0,0,0,0.45);
      border-color: #38bdf8;
    }

    .product-image {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .product-name {
      font-size: 0.95rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
    }

    .product-price {
      font-size: 0.9rem;
      color: #a5b4fc;
      text-align: center;
    }

    .summary-card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      margin-bottom: 12px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .summary-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-list {
      font-size: 0.9rem;
      margin-bottom: 8px;
      min-height: 40px;
    }

    .summary-list p {
      margin: 2px 0;
    }

    .summary-empty {
      color: #6b7280;
      font-style: italic;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1rem;
      font-weight: 600;
      padding-top: 6px;
      border-top: 1px solid #1f2937;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }

    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      opacity: 0.95;
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 4px 10px rgba(34,197,94,0.4);
    }

    .btn-secondary {
      background: #334155;
      color: #e5e7eb;
      box-shadow: 0 4px 10px rgba(15,23,42,0.6);
    }

    .btn-pay {
      background: #facc15;
      color: #1e3a8a;
      box-shadow: 0 4px 12px rgba(250, 204, 21, 0.7);
      border: 2px solid #1d4ed8;
    }

    .btn-danger {
      background: #dc2626;
      color: #fee2e2;
      box-shadow: 0 4px 10px rgba(220,38,38,0.7);
      border: 2px solid #7f1d1d;
    }

    .footer-text {
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <div class="header-logo">
      <img src="img/semillitas.jpg" alt="Jard칤n Semillitas" class="logo-img">
    </div>

    <h1>Ventas Medio Mayor - Jard칤n Semillitas</h1>
    <p class="subtitle">Toca un producto para agregarlo a la venta actual.</p>

    <div class="realtime-card">
      <span class="realtime-label">Venta acumulada hoy:</span>
      <span id="realtime-amount" class="realtime-amount">$0</span>
    </div>

    <div class="products-grid">

      <button class="product-card" data-producto="Empanada de queso" data-precio="1000" type="button">
        <img src="img/empanada.jpg" alt="Empanada de queso" class="product-image"/>
        <div class="product-name">Empanada de queso</div>
        <div class="product-price">$1.000 c/u</div>
      </button>

      <button class="product-card" data-producto="Papas fritas" data-precio="2000" type="button">
        <img src="img/papas.jpg" alt="Papas fritas" class="product-image"/>
        <div class="product-name">Papas fritas</div>
        <div class="product-price">$2.000 por porci칩n</div>
      </button>

    </div>

    <div class="summary-card">
      <div class="summary-header">
        <span class="summary-title">Venta actual</span>
        <span id="items-count">0 칤tems</span>
      </div>

      <div id="summary-list" class="summary-list">
        <p class="summary-empty">A칰n no agregas productos.</p>
      </div>

      <div class="summary-total">
        <span>Total</span>
        <span id="total-amount">$0</span>
      </div>

      <div class="btn-row">
        <button id="btn-nueva" class="btn btn-secondary">Nueva venta</button>
        <button id="btn-cobrar" class="btn btn-pay">Cobrar / Imprimir</button>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-header">
        <span class="summary-title">Cierre del d칤a</span>
        <span id="cierre-fecha"></span>
      </div>

      <div class="summary-list">
        <p id="cierre-empanadas">Empanadas: 0</p>
        <p id="cierre-papas">Papas fritas: 0</p>
        <p id="cierre-total">Total vendido: $0</p>
      </div>

      <div class="btn-row">
        <button id="btn-ver-cierre" class="btn btn-secondary">Ver cierre</button>
        <button id="btn-imprimir-cierre" class="btn btn-primary">Imprimir cierre</button>
        <button id="btn-reset-cierre" class="btn btn-danger">Reset d칤a</button>
      </div>
    </div>

    <p class="footer-text">Funciona offline y lista para impresi칩n USB en Mac.</p>

  </div>

<script>
/* ------------------------------
   PWA + L칍GICA ORIGINAL
-------------------------------- */

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
  });
}

const productos = {};

const summaryList = document.getElementById('summary-list');
const totalAmount = document.getElementById('total-amount');
const itemsCount = document.getElementById('items-count');
const btnNueva = document.getElementById('btn-nueva');
const btnCobrar = document.getElementById('btn-cobrar');

const cierreFecha = document.getElementById('cierre-fecha');
const cierreEmpanadas = document.getElementById('cierre-empanadas');
const cierrePapas = document.getElementById('cierre-papas');
const cierreTotal = document.getElementById('cierre-total');
const btnVerCierre = document.getElementById('btn-ver-cierre');
const btnImprimirCierre = document.getElementById('btn-imprimir-cierre');
const btnResetCierre = document.getElementById('btn-reset-cierre');

const realtimeAmountEl = document.getElementById('realtime-amount');

const STORAGE_KEY_TOTALES = 'totalesDiaEmpanadasPapas';
const STORAGE_KEY_TICKETS = 'ticketsDiaEmpanadasPapas';
const STORAGE_KEY_CIERRES = 'cierresDiaSemillitas';


function formatearCLP(valor) {
  return valor.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0});
}

function getFechaClave() {
  const hoy = new Date();
  return `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
}


/* ----------------------------------------
      C츼LCULO + RESUMEN VENTA ACTUAL
----------------------------------------- */

function calcularVentaActual() {
  const items = [];
  let total = 0;

  for (const nombre of Object.keys(productos)) {
    const item = productos[nombre];
    const subtotal = item.precio * item.cantidad;
    items.push({ nombre, precio:item.precio, cantidad:item.cantidad, subtotal });
    total += subtotal;
  }
  return { items, total };
}

function actualizarResumen() {
  const nombres = Object.keys(productos);
  summaryList.innerHTML = '';

  if (nombres.length === 0) {
    summaryList.innerHTML = '<p class="summary-empty">A칰n no agregas productos.</p>';
    totalAmount.textContent = '$0';
    itemsCount.textContent = '0 칤tems';
    return;
  }

  const { items, total } = calcularVentaActual();
  let cantidadTotal = 0;

  items.forEach(item => {
    cantidadTotal += item.cantidad;
    const p = document.createElement('p');
    p.textContent = `${item.cantidad} x ${item.nombre} = ${formatearCLP(item.subtotal)}`;
    summaryList.appendChild(p);
  });

  totalAmount.textContent = formatearCLP(total);
  itemsCount.textContent = `${cantidadTotal} 칤tem${cantidadTotal!==1?'s':''}`;
}


function agregarProducto(nombre, precio) {
  if (!productos[nombre]) productos[nombre]={precio, cantidad:0};
  productos[nombre].cantidad++;
  actualizarResumen();
}


/* ------------------------------
   TOTALES + LOCALSTORAGE
-------------------------------- */

function obtenerTotalesHoy() {
  const fechaClave = getFechaClave();
  let data = {};

  try { data = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||'{}'); }
  catch (e) {}

  const totales = data[fechaClave] || {empanadas:0, papas:0, total:0};
  return {fechaClave, totales, data};
}

function cargarTotalesDia() {
  const { fechaClave, totales } = obtenerTotalesHoy();
  cierreFecha.textContent = fechaClave;
  cierreEmpanadas.textContent = `Empanadas: ${totales.empanadas}`;
  cierrePapas.textContent = `Papas fritas: ${totales.papas}`;
  cierreTotal.textContent = `Total vendido: ${formatearCLP(totales.total)}`;
  realtimeAmountEl.textContent = formatearCLP(totales.total);
}

function actualizarTotalesDiaDesdeVenta() {
  const { fechaClave, totales, data } = obtenerTotalesHoy();
  const { items, total } = calcularVentaActual();

  items.forEach(item=>{
    if (item.nombre==="Empanada de queso") totales.empanadas += item.cantidad;
    if (item.nombre==="Papas fritas") totales.papas += item.cantidad;
  });

  totales.total += total;
  data[fechaClave] = totales;
  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(data));
  cargarTotalesDia();
}


/* -----------------------------------
   REGISTRO DE TICKETS POR D칈A
-------------------------------------- */

function obtenerTicketsHoy() {
  const fechaClave = getFechaClave();
  let data={};

  try { data = JSON.parse(localStorage.getItem(STORAGE_KEY_TICKETS)||'{}'); }
  catch(e){}

  const tickets = data[fechaClave] || [];
  return {fechaClave, tickets, data};
}

function guardarTicketDelDia(ticket) {
  const {fechaClave, tickets, data} = obtenerTicketsHoy();
  tickets.push(ticket);
  data[fechaClave] = tickets;
  localStorage.setItem(STORAGE_KEY_TICKETS, JSON.stringify(data));
}


/* -----------------------------------
         TICKET DE IMPRESI칍N
-------------------------------------- */

function generarTextoTicket() {
  const fecha = new Date().toLocaleString('es-CL');
  const { items, total } = calcularVentaActual();

  let t='';
  t+='COMPROBANTE VENTA - MEDIO MAYOR\n';
  t+='     JARD칈N SEMILLITAS\n';
  t+='-----------------------------\n';
  t+=fecha+'\n';
  t+='-----------------------------\n';

  if (items.length===0) t+='SIN PRODUCTOS\n';
  else {
    items.forEach(i=>{
      t+=`${i.cantidad} x ${i.nombre}\n`;
      t+=`   ${formatearCLP(i.precio)} c/u -> ${formatearCLP(i.subtotal)}\n`;
    });
  }

  t+='-----------------------------\n';
  t+=`TOTAL: ${formatearCLP(total)}\n`;
  t+='Gracias por su compra\n\n\n';
  return t;
}


/* ----------------------------------------
       TICKET: CIERRE DETALLADO
----------------------------------------- */

function generarTextoCierreDiaDetallado() {
  const { fechaClave } = obtenerTotalesHoy();
  const { tickets } = obtenerTicketsHoy();

  let t='';
  t+='         CIERRE DEL D칈A         \n';
  t+=' EMPANADAS / PAPAS - SEMILLITAS \n';
  t+='-----------------------------\n';
  t+=`Fecha: ${fechaClave}\n`;
  t+='-----------------------------\n';

  let totalGeneral=0, totalEmp=0, totalPapas=0;

  if (tickets.length===0) {
    t+='SIN VENTAS REGISTRADAS\n\n\n';
    return t;
  }

  tickets.forEach((tk,i)=>{
    const hora = new Date(tk.fechaHoraISO).toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
    t+=`Ticket #${i+1} - ${hora}\n`;

    tk.items.forEach(it=>{
      t+=` ${it.cantidad}x ${it.nombre}\n`;
      t+=`   -> ${formatearCLP(it.subtotal)}\n`;

      if (it.nombre==="Empanada de queso") totalEmp+=it.cantidad;
      if (it.nombre==="Papas fritas") totalPapas+=it.cantidad;
    });

    totalGeneral+=tk.total;
    t+=` TOTAL TICKET: ${formatearCLP(tk.total)}\n`;
    t+='-----------------------------\n';
  });

  t+='RESUMEN DEL D칈A\n';
  t+=` Empanadas: ${totalEmp}\n`;
  t+=` Papas fritas: ${totalPapas}\n`;
  t+=` TOTAL GENERAL: ${formatearCLP(totalGeneral)}\n\n\n`;
  return t;
}


/* ----------------------------------------
  游댠 FUNCI칍N DE IMPRESI칍N USB PARA MAC
----------------------------------------- */

async function imprimirTicketBluetooth(ticketTexto) {

  const printWindow = window.open('', '_blank', 'width=400,height=600');

  if (!printWindow) {
    alert('El navegador bloque칩 la ventana emergente. Habilita popups para poder imprimir.');
    return;
  }

  const safe = ticketTexto
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');

  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Ticket</title>
      <style>
        body {
          margin: 0;
          padding: 8px;
          font-family: "Courier New", monospace;
        }
        .ticket {
          width: 230px;
          font-size: 12px;
          white-space: pre-wrap;
        }
        @page { margin: 5mm; }
      </style>
    </head>
    <body>
      <div class="ticket">${safe}</div>
      <script>
        window.onload = () => window.print();
      </script>
    </body>
    </html>
  `);

  printWindow.document.close();
}


/* ----------------------------------------
         EVENTOS BOTONES
----------------------------------------- */

document.querySelectorAll('.product-card').forEach(btn=>{
  btn.addEventListener('click',()=>agregarProducto(btn.dataset.producto, Number(btn.dataset.precio)));
});

btnNueva.addEventListener('click', ()=>{
  Object.keys(productos).forEach(k=>delete productos[k]);
  actualizarResumen();
});

btnCobrar.addEventListener('click', async ()=>{
  if (Object.keys(productos).length===0) {
    alert('No hay productos en la venta.');
    return;
  }

  const fecha = new Date();

  actualizarTotalesDiaDesdeVenta();

  guardarTicketDelDia({
    fechaHoraISO: fecha.toISOString(),
    items: calcularVentaActual().items,
    total: calcularVentaActual().total
  });

  await imprimirTicketBluetooth(generarTextoTicket());

  Object.keys(productos).forEach(k=>delete productos[k]);
  actualizarResumen();
});

btnVerCierre.addEventListener('click', ()=>{
  cargarTotalesDia();
  alert('Cierre del d칤a actualizado.');
});

btnImprimirCierre.addEventListener('click', async ()=>{
  await imprimirTicketBluetooth(generarTextoCierreDiaDetallado());
});


btnResetCierre.addEventListener('click', ()=>{
  const fechaClave=getFechaClave();
  let tot={},tick={},cierres={};

  try{tot = JSON.parse(localStorage.getItem(STORAGE_KEY_TOTALES)||'{}');}catch(e){}
  try{tick = JSON.parse(localStorage.getItem(STORAGE_KEY_TICKETS)||'{}');}catch(e){}
  try{cierres = JSON.parse(localStorage.getItem(STORAGE_KEY_CIERRES)||'{}');}catch(e){}

  if (!tot[fechaClave] && !tick[fechaClave]) {
    alert('No hay datos del d칤a.');
    return;
  }

  if(!confirm("ATENCI칍N (1/3): 쯉eguro que quieres resetear el d칤a?"))return;
  if(!confirm("CONFIRMACI칍N (2/3): Esta acci칩n es irreversible. 쮺ontinuar?"))return;
  if(!confirm("칔LTIMA (3/3): 쮺onfirmas cierre definitivo del d칤a?"))return;

  const totHoy = tot[fechaClave] || {empanadas:0,papas:0,total:0};
  const ahora = new Date();

  if(!cierres[fechaClave]) cierres[fechaClave]=[];
  cierres[fechaClave].push({
    fecha: fechaClave,
    cierreISO: ahora.toISOString(),
    cierreHoraLocal: ahora.toLocaleString('es-CL'),
    totalEmpanadas: totHoy.empanadas,
    totalPapas: totHoy.papas,
    totalGeneral: totHoy.total
  });

  localStorage.setItem(STORAGE_KEY_CIERRES, JSON.stringify(cierres));

  delete tot[fechaClave];
  delete tick[fechaClave];

  localStorage.setItem(STORAGE_KEY_TOTALES, JSON.stringify(tot));
  localStorage.setItem(STORAGE_KEY_TICKETS, JSON.stringify(tick));

  cargarTotalesDia();
  alert("D칤a reseteado y cierre guardado.");
});


/* Estado inicial */
actualizarResumen();
cargarTotalesDia();
</script>

</body>
</html>
